{"version":3,"sources":["../../ts/public/query_part_editor.js"],"names":[],"mappings":";;;;;;;;AAAA,aAAO,CACL,SADK,EAEL,QAFK,EAGL,QAHK,CAAP,EAKA,UAAU,OAAV,EAAmB,CAAnB,EAAsB,CAAtB,EAAyB;AACvB;;AAEA,gBACG,MADH,CACU,oBADV,EAEG,SAFH,CAEa,oBAFb,EAEmC,UAAS,QAAT,EAAmB,WAAnB,EAAgC;;AAE/D,cAAI,gBAAgB,4CACA,oDADpB;AAEA,iBAAO;AACL,sBAAU,GADL;AAEL,yBAAa,8DAFR;AAGL,mBAAO;AACL,oBAAM,GADD;AAEL,4BAAc,GAFT;AAGL,2BAAa,GAHR;AAIL,0BAAY;AAJP,aAHF;AASL,kBAAM,SAAS,QAAT,CAAkB,MAAlB,EAA0B,IAA1B,EAAgC;AACpC,kBAAI,OAAO,OAAO,IAAlB;AACA,kBAAI,UAAU,KAAK,GAAnB;AACA,kBAAI,mBAAmB,KAAK,IAAL,CAAU,wBAAV,CAAvB;AACA,kBAAI,qBAAqB,KAAK,IAAL,CAAU,2BAAV,CAAzB;;AAEA,uBAAS,cAAT,CAAwB,UAAxB,EAAoC;;AAElC,oBAAI,QAAQ,EAAE,IAAF,CAAZ;AACA,oBAAI,SAAS,MAAM,IAAN,EAAb;;AAEA,uBAAO,GAAP,CAAW,KAAK,MAAL,CAAY,UAAZ,CAAX;AACA,uBAAO,GAAP,CAAW,OAAX,EAAqB,MAAM,KAAN,KAAgB,EAAjB,GAAuB,IAA3C;;AAEA,sBAAM,IAAN;AACA,uBAAO,IAAP;AACA,uBAAO,KAAP;AACA,uBAAO,MAAP;;AAEA,oBAAI,YAAY,OAAO,IAAP,CAAY,WAAZ,CAAhB;AACA,oBAAI,SAAJ,EAAe;AACb,yBAAO,GAAP,CAAW,EAAX;AACA,4BAAU,MAAV;AACD;AACF;;AAED,uBAAS,SAAT,CAAmB,UAAnB,EAA+B;;AAE7B,oBAAI,SAAS,EAAE,IAAF,CAAb;AACA,oBAAI,QAAQ,OAAO,IAAP,EAAZ;AACA,oBAAI,WAAW,OAAO,GAAP,EAAf;;AAEA,oBAAI,aAAa,EAAb,IAAmB,KAAK,GAAL,CAAS,MAAT,CAAgB,UAAhB,EAA4B,QAAnD,EAA6D;AAC3D,wBAAM,IAAN,CAAW,YAAY,wBAAZ,CAAqC,QAArC,CAAX;;AAEA,uBAAK,WAAL,CAAiB,OAAO,GAAP,EAAjB,EAA+B,UAA/B;AACA,yBAAO,MAAP,CAAc,OAAO,WAArB;AACD;;AAED,uBAAO,IAAP;AACA,sBAAM,IAAN;AACD;;AAED,uBAAS,aAAT,CAAuB,UAAvB,EAAmC,CAAnC,EAAsC;;AAEpC,oBAAG,EAAE,KAAF,KAAY,EAAf,EAAmB;AACjB,4BAAU,IAAV,CAAe,IAAf,EAAqB,UAArB;AACD;AACF;;AAED,uBAAS,YAAT,GAAwB;;AAEtB,qBAAK,KAAL,CAAW,KAAX,GAAmB,CAAC,IAAI,KAAK,KAAL,CAAW,MAAhB,IAA0B,CAA1B,GAA8B,IAAjD;AACD;;AAED,uBAAS,YAAT,CAAsB,MAAtB,EAA8B,KAA9B,EAAqC,UAArC,EAAiD;AAC/C,oBAAI,CAAC,MAAM,OAAP,IAAkB,CAAC,MAAM,aAA7B,EAA4C;AAC1C;AACD;;AAED,oBAAI,kBAAkB,SAAlB,eAAkB,CAAU,KAAV,EAAiB,QAAjB,EAA2B;AAC/C,sBAAI,MAAM,OAAV,EAAmB;AAAE,2BAAO,MAAM,OAAb;AAAuB;;AAE5C,yBAAO,MAAP,CAAc,YAAW;AACvB,2BAAO,UAAP,GAAoB,IAApB,CAAyB,UAAS,MAAT,EAAiB;AACxC,0BAAI,iBAAiB,EAAE,GAAF,CAAM,MAAN,EAAc,UAAS,EAAT,EAAa;AAAE,+BAAO,GAAG,KAAV;AAAkB,uBAA/C,CAArB;AACA,+BAAS,cAAT;AACD,qBAHD;AAID,mBALD;AAMD,iBATD;;AAWA,uBAAO,IAAP,CAAY,cAAZ,EAA4B,WAA5B;AACA,oBAAI,UAAU,MAAM,OAApB;AACA,oBAAI,MAAM,IAAN,KAAe,KAAnB,EAA0B;AACxB,4BAAU,EAAE,GAAF,CAAM,OAAN,EAAe,UAAS,GAAT,EAAc;AAAE,2BAAO,IAAI,QAAJ,EAAP;AAAwB,mBAAvD,CAAV;AACD;;AAED,uBAAO,SAAP,CAAiB;AACf,0BAAQ,eADO;AAEf,6BAAW,CAFI;AAGf,yBAAO,IAHQ;AAIf,2BAAS,iBAAU,KAAV,EAAiB;AACxB,+BAAW,YAAW;AACpB,gCAAU,IAAV,CAAe,OAAO,CAAP,CAAf,EAA0B,UAA1B;AACD,qBAFD,EAEG,CAFH;AAGA,2BAAO,KAAP;AACD;AATc,iBAAjB;;AAYA,oBAAI,YAAY,OAAO,IAAP,CAAY,WAAZ,CAAhB;AACA,0BAAU,MAAV,GAAmB,YAAY;AAC7B,uBAAK,KAAL,GAAa,KAAK,QAAL,CAAc,GAAd,MAAuB,EAApC;AACA,sBAAI,QAAQ,KAAK,MAAL,CAAY,KAAK,KAAjB,EAAwB,EAAE,KAAF,CAAQ,KAAK,OAAb,EAAsB,IAAtB,CAAxB,CAAZ;AACA,yBAAO,QAAQ,KAAK,OAAL,CAAa,KAAb,CAAR,GAA8B,KAArC;AACD,iBAJD;AAKD;;AAED,qBAAO,cAAP,GAAwB,YAAW;AACjC,oBAAI,YAAY,KAAK,OAAL,CAAa,aAAb,CAAhB;;AAEA,oBAAI,KAAK,QAAL,CAAc,wBAAd,CAAJ,EAA6C;AAC3C,uBAAK,WAAL,CAAiB,wBAAjB;AACA,4BAAU,WAAV,CAAsB,mBAAtB;AACA,qCAAmB,IAAnB;AACA;AACD;;AAED,qBAAK,QAAL,CAAc,wBAAd;AACA,0BAAU,QAAV,CAAmB,mBAAnB;AACA,mCAAmB,IAAnB;AACD,eAbD;;AAeA,qBAAO,oBAAP,GAA8B,YAAW;AACvC,uBAAO,cAAP;AACA,uBAAO,YAAP;AACD,eAHD;;AAKA,uBAAS,qBAAT,GAAiC;AAC/B,kBAAE,IAAF,CAAO,QAAQ,MAAf,EAAuB,UAAS,KAAT,EAAgB,KAAhB,EAAuB;AAC5C,sBAAI,MAAM,QAAN,IAAkB,KAAK,MAAL,CAAY,MAAZ,IAAsB,KAA5C,EAAmD;AACjD;AACD;;AAED,sBAAI,QAAQ,CAAZ,EAAe;AACb,sBAAE,iBAAF,EAAqB,QAArB,CAA8B,gBAA9B;AACD;;AAED,sBAAI,aAAa,YAAY,wBAAZ,CAAqC,KAAK,MAAL,CAAY,KAAZ,CAArC,CAAjB;AACA,sBAAI,aAAa,EAAE,iDAAiD,UAAjD,GAA8D,MAAhE,CAAjB;AACA,sBAAI,SAAS,EAAE,aAAF,CAAb;;AAEA,6BAAW,QAAX,CAAoB,gBAApB;AACA,yBAAO,QAAP,CAAgB,gBAAhB;;AAEA,yBAAO,IAAP,CAAY,EAAE,OAAF,CAAU,SAAV,EAAqB,KAArB,CAAZ;AACA,yBAAO,KAAP,CAAa,YAAb;AACA,yBAAO,QAAP,CAAgB,EAAE,OAAF,CAAU,aAAV,EAAyB,KAAzB,CAAhB;AACA,6BAAW,KAAX,CAAiB,EAAE,OAAF,CAAU,cAAV,EAA0B,KAA1B,CAAjB;;AAEA,+BAAa,MAAb,EAAqB,KAArB,EAA4B,KAA5B;AACD,iBAtBD;AAuBD;;AAED,uBAAS,MAAT,GAAkB;AAChB,iCAAiB,KAAjB;AACA;AACD;;AAED;AACD;AA9JI,WAAP;AAiKD,SAvKH;AAyKD,OAjLD","file":"query_part_editor.js","sourcesContent":["define([\n  'angular',\n  'lodash',\n  'jquery',\n],\nfunction (angular, _, $) {\n  'use strict';\n\n  angular\n    .module('grafana.directives')\n    .directive('sqlQueryPartEditor', function($compile, templateSrv) {\n\n      var paramTemplate = '<input type=\"text\" style=\"display:none\"' +\n                          ' class=\"input-mini tight-form-func-param\"></input>';\n      return {\n        restrict: 'E',\n        templateUrl: 'public/app/plugins/datasource/sqldb/partials/query_part.html',\n        scope: {\n          part: \"=\",\n          removeAction: \"&\",\n          partUpdated: \"&\",\n          getOptions: \"&\",\n        },\n        link: function postLink($scope, elem) {\n          var part = $scope.part;\n          var partDef = part.def;\n          var $paramsContainer = elem.find('.query-part-parameters');\n          var $controlsContainer = elem.find('.tight-form-func-controls');\n\n          function clickFuncParam(paramIndex) {\n            /*jshint validthis:true */\n            var $link = $(this);\n            var $input = $link.next();\n\n            $input.val(part.params[paramIndex]);\n            $input.css('width', ($link.width() + 16) + 'px');\n\n            $link.hide();\n            $input.show();\n            $input.focus();\n            $input.select();\n\n            var typeahead = $input.data('typeahead');\n            if (typeahead) {\n              $input.val('');\n              typeahead.lookup();\n            }\n          }\n\n          function inputBlur(paramIndex) {\n            /*jshint validthis:true */\n            var $input = $(this);\n            var $link = $input.prev();\n            var newValue = $input.val();\n\n            if (newValue !== '' || part.def.params[paramIndex].optional) {\n              $link.html(templateSrv.highlightVariablesAsHtml(newValue));\n\n              part.updateParam($input.val(), paramIndex);\n              $scope.$apply($scope.partUpdated);\n            }\n\n            $input.hide();\n            $link.show();\n          }\n\n          function inputKeyPress(paramIndex, e) {\n            /*jshint validthis:true */\n            if(e.which === 13) {\n              inputBlur.call(this, paramIndex);\n            }\n          }\n\n          function inputKeyDown() {\n            /*jshint validthis:true */\n            this.style.width = (3 + this.value.length) * 8 + 'px';\n          }\n\n          function addTypeahead($input, param, paramIndex) {\n            if (!param.options && !param.dynamicLookup) {\n              return;\n            }\n\n            var typeaheadSource = function (query, callback) {\n              if (param.options) { return param.options; }\n\n              $scope.$apply(function() {\n                $scope.getOptions().then(function(result) {\n                  var dynamicOptions = _.map(result, function(op) { return op.value; });\n                  callback(dynamicOptions);\n                });\n              });\n            };\n\n            $input.attr('data-provide', 'typeahead');\n            var options = param.options;\n            if (param.type === 'int') {\n              options = _.map(options, function(val) { return val.toString(); });\n            }\n\n            $input.typeahead({\n              source: typeaheadSource,\n              minLength: 0,\n              items: 1000,\n              updater: function (value) {\n                setTimeout(function() {\n                  inputBlur.call($input[0], paramIndex);\n                }, 0);\n                return value;\n              }\n            });\n\n            var typeahead = $input.data('typeahead');\n            typeahead.lookup = function () {\n              this.query = this.$element.val() || '';\n              var items = this.source(this.query, $.proxy(this.process, this));\n              return items ? this.process(items) : items;\n            };\n          }\n\n          $scope.toggleControls = function() {\n            var targetDiv = elem.closest('.tight-form');\n\n            if (elem.hasClass('show-function-controls')) {\n              elem.removeClass('show-function-controls');\n              targetDiv.removeClass('has-open-function');\n              $controlsContainer.hide();\n              return;\n            }\n\n            elem.addClass('show-function-controls');\n            targetDiv.addClass('has-open-function');\n            $controlsContainer.show();\n          };\n\n          $scope.removeActionInternal = function() {\n            $scope.toggleControls();\n            $scope.removeAction();\n          };\n\n          function addElementsAndCompile() {\n            _.each(partDef.params, function(param, index) {\n              if (param.optional && part.params.length <= index) {\n                return;\n              }\n\n              if (index > 0) {\n                $('<span>, </span>').appendTo($paramsContainer);\n              }\n\n              var paramValue = templateSrv.highlightVariablesAsHtml(part.params[index]);\n              var $paramLink = $('<a class=\"graphite-func-param-link pointer\">' + paramValue + '</a>');\n              var $input = $(paramTemplate);\n\n              $paramLink.appendTo($paramsContainer);\n              $input.appendTo($paramsContainer);\n\n              $input.blur(_.partial(inputBlur, index));\n              $input.keyup(inputKeyDown);\n              $input.keypress(_.partial(inputKeyPress, index));\n              $paramLink.click(_.partial(clickFuncParam, index));\n\n              addTypeahead($input, param, index);\n            });\n          }\n\n          function relink() {\n            $paramsContainer.empty();\n            addElementsAndCompile();\n          }\n\n          relink();\n        }\n      };\n\n    });\n\n});\n"]}